<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datacenter Inventory Mapping - Essential Energy Automation Hub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            padding-bottom: 50px;
        }
        .header {
            background: linear-gradient(135deg, #05386B, #379683);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .card-header {
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
            background-color: #379683;
            color: white;
        }
        .btn-custom {
            background-color: #379683;
            border-color: #379683;
            color: white;
        }
        .btn-custom:hover {
            background-color: #05386B;
            border-color: #05386B;
            color: white;
        }
        .info-box {
            background-color: #e7f3ef;
            border-left: 4px solid #379683;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .badge-spine {
            background-color: #6f42c1;
            color: white;
        }
        .badge-leaf {
            background-color: #20c997;
            color: white;
        }
        .badge-border-leaf {
            background-color: #fd7e14;
            color: white;
        }
        .badge-apic {
            background-color: #0d6efd;
            color: white;
        }
        .badge-ndo {
            background-color: #dc3545;
            color: white;
        }
        .badge-unknown {
            background-color: #6c757d;
            color: white;
        }
        .badge-router, .badge-switch, .badge-firewall, .badge-load-balancer, .badge-custom {
            background-color: #6610f2;
            color: white;
        }
        .badge-edited {
            background-color: #ffc107;
            color: #212529;
        }
        .edit-mode {
            background-color: #f8f9fa;
        }
        .refresh-btn {
            position: absolute;
            right: 20px;
            top: 15px;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        /* Table width improvements */
        .table {
            width: 100%;
            table-layout: auto;
        }
        
        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }
        
        .container {
            max-width: 95%;
            width: 95%;
        }
        
        .card-body {
            padding: 1rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1 class="display-5 fw-bold">Datacenter Inventory Mapping</h1>
            <p class="lead">Track and map hostnames to hardware details for Essential Energy datacenters</p>
        </div>
    </div>

    <div class="container">
        <div class="home-link">
            <a href="index.html" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Hub
            </a>
        </div>

        <!-- Info section -->
        <div class="card mt-4">
            <div class="card-header">
                About This Tool
            </div>
            <div class="card-body">
                <div class="info-box">
                    <h5><i class="bi bi-info-circle"></i> What is this?</h5>
                    <p>This tool automatically tracks hostnames generated in the Essential Energy Automation Hub and maps them to hardware details from the ACI Core Components inventory.</p>
                    <p>It monitors the shared database for hostnames with site codes <strong>AUNTH</strong> (Northern DC), <strong>AUSTH</strong> (Southern DC), and <strong>AUTER</strong> (Tertiary DC) and displays their corresponding hardware specifications.</p>
                </div>
            </div>
        </div>

        <!-- Filter section -->
        <div class="card mt-4">
            <div class="card-header">
                Filter Options
                <button id="refresh-btn" class="btn btn-sm btn-outline-light refresh-btn">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Data
                </button>
            </div>
            <div class="card-body">
                <div class="filter-section">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="site-filter" class="form-label">Site Location</label>
                            <select id="site-filter" class="form-select">
                                <option value="all">All Sites</option>
                                <option value="AUNTH">Northern DC (AUNTH)</option>
                                <option value="AUSTH">Southern DC (AUSTH)</option>
                                <option value="AUTER">Tertiary DC (AUTER)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="role-filter" class="form-label">Component Role</label>
                            <select id="role-filter" class="form-select">
                                <option value="all">All Roles</option>
                                <option value="spine">Spine Switches</option>
                                <option value="leaf">Leaf Switches</option>
                                <option value="border-leaf">Border Leaf Switches</option>
                                <option value="apic">APIC Controllers</option>
                                <option value="ndo">Nexus Dashboard</option>
                                <option value="router">Routers</option>
                                <option value="switch">Switches</option>
                                <option value="firewall">Firewalls</option>
                                <option value="load-balancer">Load Balancers</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="search-filter" class="form-label">Search</label>
                            <input type="text" id="search-filter" class="form-control" placeholder="Search by hostname or product ID">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Inventory table section -->
        <div class="card mt-4">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="inventory-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="datacenter-tab" data-bs-toggle="tab" data-bs-target="#datacenter-content" type="button" role="tab" aria-controls="datacenter-content" aria-selected="true">Datacenter</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory-content" type="button" role="tab" aria-controls="inventory-content" aria-selected="false">Inventory</button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="inventory-tabs-content">
                    <!-- Datacenter Tab Content -->
                    <div class="tab-pane fade show active" id="datacenter-content" role="tabpanel" aria-labelledby="datacenter-tab">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Hostname</th>
                                        <th>Product ID</th>
                                        <th>Role</th>
                                        <th>Node ID</th>
                                        <th>Date Created</th>
                                    </tr>
                                </thead>
                                <tbody id="inventory-table-body">
                                    <!-- Inventory items will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="no-data-message" class="alert alert-info d-none">
                            No matching inventory items found. Try adjusting your filters or generate more hostnames using the Comprehensive Name Generator.
                        </div>
                    </div>
                    
                    <!-- Inventory Tab Content with Editable Fields -->
                    <div class="tab-pane fade" id="inventory-content" role="tabpanel" aria-labelledby="inventory-tab">
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle"></i> In this tab, you can edit device details and they will not be overwritten during database syncs. Edited entries are marked with <span class="badge bg-warning">Edited</span> badge.
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Hostname</th>
                                        <th>Product ID</th>
                                        <th>Description</th>
                                        <th>Port Capacity</th>
                                        <th>Rack Units</th>
                                        <th>Power Req.</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="editable-inventory-table-body">
                                    <!-- Editable inventory items will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="inventory-no-data-message" class="alert alert-info d-none">
                            No matching inventory items found. Try adjusting your filters or generate more hostnames using the Comprehensive Name Generator.
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Statistics section -->
        <div class="card mt-4">
            <div class="card-header">
                Inventory Statistics
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card mb-3">
                            <div class="card-body text-center">
                                <h5 class="card-title">Total Devices</h5>
                                <h2 id="total-devices">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Device Distribution</h5>
                                <div class="row">
                                    <div class="col-md-4 text-center mb-3">
                                        <span class="badge rounded-pill badge-spine px-3 py-2 mb-2">Spine</span>
                                        <h4 id="spine-count">0</h4>
                                    </div>
                                    <div class="col-md-4 text-center mb-3">
                                        <span class="badge rounded-pill badge-leaf px-3 py-2 mb-2">Leaf</span>
                                        <h4 id="leaf-count">0</h4>
                                    </div>
                                    <div class="col-md-4 text-center mb-3">
                                        <span class="badge rounded-pill badge-border-leaf px-3 py-2 mb-2">Border Leaf</span>
                                        <h4 id="border-leaf-count">0</h4>
                                    </div>
                                    <div class="col-md-4 text-center mb-3">
                                        <span class="badge rounded-pill badge-apic px-3 py-2 mb-2">APIC</span>
                                        <h4 id="apic-count">0</h4>
                                    </div>
                                    <div class="col-md-4 text-center mb-3">
                                        <span class="badge rounded-pill badge-ndo px-3 py-2 mb-2">NDO</span>
                                        <h4 id="ndo-count">0</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Database management section -->
        <div class="card mt-4">
            <div class="card-header">
                Database Management
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <button id="download-db-btn" class="btn btn-custom">
                            <i class="bi bi-download"></i> Download Database
                        </button>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <input class="form-control" type="file" id="db-file-input" accept=".json">
                        </div>
                        <button id="upload-db-btn" class="btn btn-custom">
                            <i class="bi bi-upload"></i> Upload Database
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="shared_database.js"></script>
    <script>
        // Define a new tool ID for the datacenter inventory mapping
        if (!DB_CONFIG.TOOLS.DATACENTER_INVENTORY) {
            DB_CONFIG.TOOLS.DATACENTER_INVENTORY = 'datacenter_inventory';
        }
        
        // Set the tool ID for this tool
        const TOOL_ID = DB_CONFIG.TOOLS.DATACENTER_INVENTORY;
        
        // ACI Core Components data for mapping
        const ACI_COMPONENTS = {
            // APIC Controllers
            'APIC': [
                { productId: 'APIC-CLUSTER-L4', description: 'APIC Cluster - Large Configurations (> 1200 Edge Ports)', portSummary: 'N/A', rackUnits: '2U', powerRequirements: '1100W', role: 'Primary APIC clusters for IT and OT domains' },
                { productId: 'APIC-CLUSTER-M4', description: 'APIC Cluster - Medium Configurations (Up to 1200 Edge Ports)', portSummary: 'N/A', rackUnits: '2U', powerRequirements: '950W', role: 'Additional APIC clusters' },
                { productId: 'APIC-SERVER-L4', description: 'APIC Appliance - Large Config. (> 1200 Edge Ports)', portSummary: 'N/A', rackUnits: '2U', powerRequirements: '1100W', role: 'Individual APIC servers for large clusters' },
                { productId: 'APIC-SERVER-M4', description: 'APIC Appliance - Medium Configuration (Up to 1200 Edge Ports)', portSummary: 'N/A', rackUnits: '2U', powerRequirements: '950W', role: 'Individual APIC servers for medium clusters' }
            ],
            // OPIC - APIC controllers with OPIC device type
            'OPIC': [
                { productId: 'APIC-CLUSTER-M4', description: 'APIC Cluster - Medium Configurations (Up to 1200 Edge Ports)', portSummary: 'N/A', rackUnits: '2U', powerRequirements: '950W', role: 'APIC Controller' },
                { productId: 'APIC-SERVER-M4', description: 'APIC Appliance - Medium Configuration (Up to 1200 Edge Ports)', portSummary: 'N/A', rackUnits: '2U', powerRequirements: '950W', role: 'APIC Controller' }
            ],
            // EPIC - APIC controllers with EPIC device type
            'EPIC': [
                { productId: 'APIC-CLUSTER-M4', description: 'APIC Cluster - Medium Configurations (Up to 1200 Edge Ports)', portSummary: 'N/A', rackUnits: '2U', powerRequirements: '950W', role: 'APIC Controller' },
                { productId: 'APIC-SERVER-M4', description: 'APIC Appliance - Medium Configuration (Up to 1200 Edge Ports)', portSummary: 'N/A', rackUnits: '2U', powerRequirements: '950W', role: 'APIC Controller' }
            ],
            // Spine Switches
            'OSPI': [
                { productId: 'N9K-C9316D-GX', description: 'Nexus 9300 Series, 16p 400G QSFP-DD', portSummary: '16x 400G QSFP-DD', rackUnits: '1U', powerRequirements: '1050W', role: 'High-performance spine switches' }
            ],
            // Leaf Switches
            'OLFS': [
                { productId: 'N9K-C93180YC-FX3', description: 'Nexus 9300 48p 1/10/25G, 6p 40/100G, MACsec, SyncE', portSummary: '48x 1/10/25G + 6x 40/100G', rackUnits: '1U', powerRequirements: '650W', role: 'High-density leaf switches' }
            ],
            'ELFS': [
                { productId: 'N9K-C93180YC-FX3', description: 'Nexus 9300 48p 1/10/25G, 6p 40/100G, MACsec, SyncE', portSummary: '48x 1/10/25G + 6x 40/100G', rackUnits: '1U', powerRequirements: '650W', role: 'Enterprise Server Leaf Switch' }
            ],
            'OLFB': [
                { productId: 'N9K-C93180YC-FX3', description: 'Nexus 9300 48p 1/10/25G, 6p 40/100G, MACsec, SyncE', portSummary: '48x 1/10/25G + 6x 40/100G', rackUnits: '1U', powerRequirements: '650W', role: 'Border leaf switches' }
            ],
            'OLFA': [
                { productId: 'N9K-C9348GC-FX3', description: 'Nexus 9300 with 48p 100M/1GT, 4p 10/25G & 2p 40/100G QSFP28', portSummary: '48x 100M/1G + 4x 10/25G + 2x 40/100G', rackUnits: '1U', powerRequirements: '600W', role: 'Access leaf switches' }
            ],
            // Nexus Dashboard Orchestrator
            'ONDO': [
                { productId: 'ND-CLUSTER-L4', description: 'Nexus Dashboard Cluster - Performance', portSummary: 'N/A', rackUnits: '4U', powerRequirements: '1500W', role: 'Management platform clusters' },
                { productId: 'ND-NODE-L4', description: 'Nexus Dashboard Node', portSummary: 'N/A', rackUnits: '1U', powerRequirements: '500W', role: 'Individual nodes for ND clusters' }
            ]
        };
        
        // Node ID allocation mapping
        const NODE_ID_MAPPING = {
            // APIC Controllers (1-5)
            'APIC': { min: 1, max: 5, role: 'apic' },
            'OPIC': { min: 1, max: 5, role: 'apic' },
            'EPIC': { min: 1, max: 5, role: 'apic' },
            
            // Data Center Identifiers
            // 1: Northern DC IT
            // 2: Northern DC OT
            // 3: Southern DC IT
            // 4: Southern DC OT
            // 5: Tertiary DC IT
            // 6: Tertiary DC OT
            
            // Spine Switches (X96-X99)
            'OSPI': { 
                'AUNTH': { prefix: '1', min: 96, max: 99, role: 'spine' },
                'AUSTH': { prefix: '3', min: 96, max: 99, role: 'spine' },
                'AUTER': { prefix: '5', min: 96, max: 99, role: 'spine' }
            },
            
            // Compute Leaf Switches (X01-X89)
            'OLFS': { 
                'AUNTH': { prefix: '1', min: 1, max: 89, role: 'leaf' },
                'AUSTH': { prefix: '3', min: 1, max: 89, role: 'leaf' },
                'AUTER': { prefix: '5', min: 1, max: 89, role: 'leaf' }
            },
            
            // Enterprise Server Leaf Switches (X01-X89)
            'ELFS': { 
                'AUNTH': { prefix: '1', min: 1, max: 89, role: 'leaf' },
                'AUSTH': { prefix: '3', min: 1, max: 89, role: 'leaf' },
                'AUTER': { prefix: '5', min: 1, max: 89, role: 'leaf' }
            },
            
            // Border Leaf Switches (X90-X95)
            'OLFB': { 
                'AUNTH': { prefix: '1', min: 90, max: 95, role: 'border-leaf' },
                'AUSTH': { prefix: '3', min: 90, max: 95, role: 'border-leaf' },
                'AUTER': { prefix: '5', min: 90, max: 95, role: 'border-leaf' }
            }
        };
        
        // Initialize database when page loads
        window.addEventListener('DOMContentLoaded', () => {
            initDatabase(TOOL_ID).then(() => {
                loadInventoryData();
            }).catch(error => {
                console.error("Failed to initialize database:", error);
                alert("Failed to initialize database. Some features may not work correctly.");
            });
            
            // Database management event listeners
            document.getElementById('download-db-btn').addEventListener('click', function() {
                downloadDatabase();
            });
            
            document.getElementById('upload-db-btn').addEventListener('click', function() {
                const fileInput = document.getElementById('db-file-input');
                if (fileInput.files.length === 0) {
                    alert('Please select a file to upload');
                    return;
                }
                
                const file = fileInput.files[0];
                
                uploadDatabase(file)
                    .then(() => {
                        alert('Database uploaded successfully');
                        loadInventoryData();
                    })
                    .catch(error => {
                        alert(`Failed to upload database: ${error}`);
                    });
            });
            
            // Filter event listeners
            document.getElementById('site-filter').addEventListener('change', applyFilters);
            document.getElementById('role-filter').addEventListener('change', applyFilters);
            document.getElementById('search-filter').addEventListener('input', applyFilters);
            
            // Refresh button event listener
            document.getElementById('refresh-btn').addEventListener('click', loadInventoryData);
            
            // Set up polling to check for database changes
            setInterval(checkForDatabaseChanges, 5000);
        });
        
        // Last updated timestamp to track changes
        let lastUpdatedTimestamp = null;
        
        // Check for database changes
        function checkForDatabaseChanges() {
            // Check the comprehensive generator database for changes
            getLastUpdatedTimestamp(DB_CONFIG.TOOLS.COMPREHENSIVE_GENERATOR)
                .then(timestamp => {
                    if (timestamp && timestamp !== lastUpdatedTimestamp) {
                        lastUpdatedTimestamp = timestamp;
                        loadInventoryData();
                    }
                })
                .catch(error => {
                    console.error("Error checking for database changes:", error);
                });
        }
        
        // Migrate APIC controller entries to use the correct models from bill of materials
        function migrateApicControllerEntries(records) {
            // Skip migration if no records
            if (!records || records.length === 0) return records;
            
            // Flag to track if any records were updated
            let updatedRecords = false;
            
            // Loop through all records and update APIC controllers with outdated models
            const migratedRecords = records.map(record => {
                // Skip non-host naming records
                if (record.conventionType !== 'Host Naming') return record;
                
                // Get the device type from the hostname
                const hostname = record.name;
                if (!hostname) return record;
                
                // Check if this is a datacenter hostname
                if (!hostname.startsWith('AUNTH') && !hostname.startsWith('AUSTH') && !hostname.startsWith('AUTER')) {
                    return record;
                }
                
                // Extract the device type (4 characters before the last 4 digits)
                const deviceType = hostname.substring(hostname.length - 8, hostname.length - 4);
                
                // Skip if not an APIC controller type
                if (deviceType !== 'APIC' && deviceType !== 'OPIC' && deviceType !== 'EPIC') {
                    return record;
                }
                
                // Check if this record has details that need updating
                if (record.details) {
                    // Check for outdated APIC-SERVER-M3 model or Unknown product
                    if (record.details.productId === 'APIC-SERVER-M3' || 
                        record.details.productId === 'Unknown' ||
                        !record.details.productId) {
                        
                        // Get the correct hardware details for this device type
                        const role = determineRole('', deviceType, '');
                        const hardwareDetails = determineHardwareDetails(deviceType, role);
                        
                        // Update the details with the correct model
                        record.details.productId = hardwareDetails.productId;
                        record.details.description = hardwareDetails.description;
                        record.details.portSummary = hardwareDetails.portSummary;
                        record.details.role = hardwareDetails.role;
                        
                        // Flag that we updated records
                        updatedRecords = true;
                    }
                }
                
                return record;
            });
            
            // If we updated any records, save the changes back to the database
            if (updatedRecords) {
                console.log("Updated outdated APIC controller models to latest versions");
                
                // For each updated record, save it back to the database
                migratedRecords.forEach(record => {
                    if (record.conventionType === 'Host Naming' && record.id) {
                        // Use the updateRecord function from shared_database.js
                        updateRecord(DB_CONFIG.TOOLS.COMPREHENSIVE_GENERATOR, record.id, {
                            details: record.details
                        }).catch(error => {
                            console.error(`Error updating record ${record.id}:`, error);
                        });
                    }
                });
            }
            
            return migratedRecords;
        }
        
        // Database schema version for migration tracking
        const CURRENT_SCHEMA_VERSION = 3; // Increment this when making schema changes
        
        // Flag to mark edited entries
        const EDITED_FLAG = 'edited';
        
        // Load inventory data from the comprehensive generator database
        function loadInventoryData() {
            // We need to load data from the comprehensive generator database
            loadRecords(DB_CONFIG.TOOLS.COMPREHENSIVE_GENERATOR)
                .then(records => {
                    if (!records || records.length === 0) {
                        showNoDataMessage();
                        updateStatistics([]);
                        return;
                    }
                    
                    // Migrate any outdated APIC controller entries
                    records = migrateApicControllerEntries(records);
                    
                    // Update the last updated timestamp
                    getLastUpdatedTimestamp(DB_CONFIG.TOOLS.COMPREHENSIVE_GENERATOR)
                        .then(timestamp => {
                            lastUpdatedTimestamp = timestamp;
                        })
                        .catch(error => {
                            console.error("Error getting last updated timestamp:", error);
                        });
                    
                    // Filter for host names with site codes AUNTH, AUSTH, and AUTER
                    const hostRecords = records.filter(record => {
                        if (record.conventionType !== 'Host Naming') return false;
                        
                        // Check if the hostname starts with one of the target site codes
                        const hostname = record.name;
                        return hostname.startsWith('AUNTH') || hostname.startsWith('AUSTH') || hostname.startsWith('AUTER');
                    });
                
                    // Process the host records and map them to hardware details
                    const inventoryItems = hostRecords.map(record => {
                        const hostname = record.name;
                        const siteLocation = hostname.substring(0, 5); // AUNTH, AUSTH, AUTER
                        
                        // Extract the 4-digit device ID from the end
                        const deviceId = hostname.substring(hostname.length - 4);
                        
                        // Extract the device type (4 characters before the deviceId)
                        const deviceType = hostname.substring(hostname.length - 8, hostname.length - 4);
                        
                        // Extract the site type (characters between siteLocation and deviceType)
                        const siteType = hostname.substring(5, hostname.length - 8);
                        
                        // Determine the role and hardware details based on device type and node ID
                        const role = determineRole(siteLocation, deviceType, deviceId);
                        const hardwareDetails = determineHardwareDetails(deviceType, role);
                        
                        return {
                            id: record.id,
                            hostname: hostname,
                            siteLocation: siteLocation,
                            siteType: siteType,
                            deviceType: deviceType,
                            deviceId: deviceId,
                            productId: hardwareDetails.productId,
                            description: hardwareDetails.description,
                            portSummary: hardwareDetails.portSummary,
                            role: hardwareDetails.role,
                            roleType: role,
                            dateCreated: record.dateCreated
                        };
                    });
                    
                    // Save the inventory items to our own database
                    saveInventoryItems(inventoryItems);
                    
                    // Apply filters and render the inventory table
                    applyFilters();
                    
                    // Update statistics
                    updateStatistics(inventoryItems);
                })
                .catch(error => {
                    console.error("Error loading inventory data:", error);
                    showNoDataMessage();
                    updateStatistics([]);
                });
        }
        
        // Save inventory items to our own database
        function saveInventoryItems(items) {
            // Track hostnames to prevent duplicates
            const uniqueHostnames = new Set();
            
            // Initialize the database for this tool
            initDatabase(TOOL_ID)
                .then(() => {
                    // Load existing records to preserve edited entries
                    return loadRecords(TOOL_ID);
                })
                .then(existingRecords => {
                    // Create a map of edited entries by hostname
                    const editedEntries = new Map();
                    
                    if (existingRecords && existingRecords.length > 0) {
                        existingRecords.forEach(record => {
                            // Check if this is an edited entry
                            if (record.details && record.details[EDITED_FLAG]) {
                                // Use hostname as the key
                                const hostname = record.name;
                                editedEntries.set(hostname, record);
                                
                                // Keep track of hostnames to prevent duplicates
                                uniqueHostnames.add(hostname);
                            } else {
                                // Delete non-edited entries
                                deleteRecord(TOOL_ID, record.id).catch(error => {
                                    console.error(`Error deleting record ${record.id}:`, error);
                                });
                            }
                        });
                    }
                    
                    // Save each item as a record, preserving edited entries
                    items.forEach(item => {
                        const hostname = item.hostname;
                        
                        // Only save if this hostname hasn't been seen already
                        if (!uniqueHostnames.has(hostname)) {
                            uniqueHostnames.add(hostname);
                            
                            const record = {
                                name: hostname,
                                conventionType: 'Inventory Item',
                                details: {
                                    siteLocation: item.siteLocation,
                                    siteType: item.siteType,
                                    deviceType: item.deviceType,
                                    deviceId: item.deviceId,
                                    productId: item.productId,
                                    description: item.description,
                                    portSummary: item.portSummary,
                                    role: item.role,
                                    roleType: item.roleType
                                },
                                userDescription: `${item.siteLocation} ${item.deviceType} ${item.deviceId}`
                            };
                            
                            saveRecord(TOOL_ID, record)
                                .catch(error => {
                                    console.error(`Error saving inventory item ${hostname}:`, error);
                                });
                        }
                    });
                })
                .catch(error => {
                    console.error("Error initializing inventory database:", error);
                });
        }
        
        // Determine the role based on device type and node ID
        function determineRole(siteLocation, deviceType, deviceId) {
            // For APIC controllers
            if (deviceType === 'APIC' || deviceType === 'OPIC' || deviceType === 'EPIC') {
                return 'apic';
            }
            
            // For NDO
            if (deviceType === 'ONDO') {
                return 'ndo';
            }
            
            // For spine and leaf switches
            if (NODE_ID_MAPPING[deviceType] && NODE_ID_MAPPING[deviceType][siteLocation]) {
                const mapping = NODE_ID_MAPPING[deviceType][siteLocation];
                const nodeId = parseInt(deviceId);
                
                // Check if the node ID falls within the range for this device type
                if (nodeId >= mapping.min && nodeId <= mapping.max) {
                    return mapping.role;
                }
            }
            
            // Default role based on device type
            if (deviceType === 'OSPI') return 'spine';
            if (deviceType === 'OLFS') return 'leaf';
            if (deviceType === 'ELFS') return 'leaf';
            if (deviceType === 'OLFB') return 'border-leaf';
            
            return 'unknown';
        }
        
        // Determine hardware details based on device type and role
        function determineHardwareDetails(deviceType, role) {
            // Default values
            let details = {
                productId: 'Unknown',
                description: 'Unknown device',
                portSummary: 'N/A',
                role: 'Unknown role'
            };
            
            // Check if we have hardware details for this device type
            if (ACI_COMPONENTS[deviceType] && ACI_COMPONENTS[deviceType].length > 0) {
                // For simplicity, use the first matching hardware details
                // In a real application, you might want to use more sophisticated matching logic
                details = ACI_COMPONENTS[deviceType][0];
            }
            
            return details;
        }
        
        // Apply filters to the inventory data
        function applyFilters() {
            const siteFilter = document.getElementById('site-filter').value;
            const roleFilter = document.getElementById('role-filter').value;
            const searchFilter = document.getElementById('search-filter').value.toLowerCase();
            
            // Load data from our database
            loadRecords(TOOL_ID)
                .then(records => {
                    if (!records || records.length === 0) {
                        showNoDataMessage();
                        return;
                    }
                    
                    // Apply filters
                    const filteredItems = records.filter(item => {
                        // For records saved with the new format
                        if (item.conventionType === 'Inventory Item' && item.details) {
                            // Site filter
                            if (siteFilter !== 'all' && item.details.siteLocation !== siteFilter) {
                                return false;
                            }
                            
                            // Role filter
                            if (roleFilter !== 'all' && item.details.roleType !== roleFilter) {
                                return false;
                            }
                            
                            // Search filter
                            if (searchFilter && !item.name.toLowerCase().includes(searchFilter) && 
                                !item.details.productId.toLowerCase().includes(searchFilter)) {
                                return false;
                            }
                            
                            return true;
                        }
                        // For records saved with the old format (direct properties)
                        else {
                            // Site filter
                            if (siteFilter !== 'all' && item.siteLocation !== siteFilter) {
                                return false;
                            }
                            
                            // Role filter
                            if (roleFilter !== 'all' && item.roleType !== roleFilter) {
                                return false;
                            }
                            
                            // Search filter
                            if (searchFilter && !item.hostname.toLowerCase().includes(searchFilter) && 
                                !item.productId.toLowerCase().includes(searchFilter)) {
                                return false;
                            }
                            
                            return true;
                        }
                    });
                    
                    // Render the filtered items
                    renderInventoryTable(filteredItems);
                })
                .catch(error => {
                    console.error("Error applying filters:", error);
                    showNoDataMessage();
                });
        }
        
        // Render the inventory table
        function renderInventoryTable(items) {
            const tableBody = document.getElementById('inventory-table-body');
            const editableTableBody = document.getElementById('editable-inventory-table-body');
            const noDataMessage = document.getElementById('no-data-message');
            const inventoryNoDataMessage = document.getElementById('inventory-no-data-message');
            
            // Clear the tables
            tableBody.innerHTML = '';
            editableTableBody.innerHTML = '';
            
            if (items.length === 0) {
                noDataMessage.classList.remove('d-none');
                inventoryNoDataMessage.classList.remove('d-none');
                return;
            }
            
            noDataMessage.classList.add('d-none');
            inventoryNoDataMessage.classList.add('d-none');
            
            // Sort items by hostname (handle both new and old format)
            items.sort((a, b) => {
                const hostnameA = a.conventionType === 'Inventory Item' ? a.name : a.hostname;
                const hostnameB = b.conventionType === 'Inventory Item' ? b.name : b.hostname;
                return hostnameA.localeCompare(hostnameB);
            });
            
            // Add items to both tables
            items.forEach(item => {
                // Handle both new and old format
                let hostname, productId, description, portSummary, rackUnits, powerRequirements, roleType, deviceId, dateCreated;
                let isEdited = false;
                let itemId = null;
                
                if (item.conventionType === 'Inventory Item' && item.details) {
                    // New format (from API)
                    hostname = item.name;
                    productId = item.details.productId;
                    description = item.details.description;
                    portSummary = item.details.portSummary || 'N/A';
                    rackUnits = item.details.rackUnits || 'N/A';
                    powerRequirements = item.details.powerRequirements || 'N/A';
                    roleType = item.details.roleType;
                    deviceId = item.details.deviceId;
                    dateCreated = item.dateCreated;
                    itemId = item.id;
                    
                    // Check if this is an edited entry
                    isEdited = item.details[EDITED_FLAG] === true;
                } else {
                    // Old format (from localStorage)
                    hostname = item.hostname;
                    productId = item.productId;
                    description = item.description;
                    portSummary = item.portSummary || 'N/A';
                    rackUnits = item.rackUnits || 'N/A';
                    powerRequirements = item.powerRequirements || 'N/A';
                    roleType = item.roleType;
                    deviceId = item.deviceId;
                    dateCreated = item.dateCreated;
                    itemId = item.id;
                }
                
                // Determine badge class based on role
                let badgeClass = 'badge-unknown';
                if (roleType === 'spine') badgeClass = 'badge-spine';
                if (roleType === 'leaf') badgeClass = 'badge-leaf';
                if (roleType === 'border-leaf') badgeClass = 'badge-border-leaf';
                if (roleType === 'apic') badgeClass = 'badge-apic';
                if (roleType === 'ndo') badgeClass = 'badge-ndo';
                if (roleType === 'router') badgeClass = 'badge-router';
                if (roleType === 'switch') badgeClass = 'badge-switch';
                if (roleType === 'firewall') badgeClass = 'badge-firewall';
                if (roleType === 'load-balancer') badgeClass = 'badge-load-balancer';
                if (roleType === 'custom') badgeClass = 'badge-custom';
                
                // Create row for datacenter tab
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${hostname}</strong></td>
                    <td>${productId}</td>
                    <td><span class="badge rounded-pill ${badgeClass}">${roleType.replace('-', ' ')}</span></td>
                    <td>${deviceId}</td>
                    <td>${new Date(dateCreated).toLocaleString()}</td>
                `;
                tableBody.appendChild(row);
                
                // Create row for inventory tab with editable fields
                const editableRow = document.createElement('tr');
                editableRow.dataset.id = itemId;
                editableRow.dataset.hostname = hostname;
                editableRow.innerHTML = `
                    <td><strong>${hostname}</strong></td>
                    <td data-field="productId">${productId}</td>
                    <td data-field="description">${description}</td>
                    <td data-field="portSummary">${portSummary}</td>
                    <td data-field="rackUnits">${rackUnits}</td>
                    <td data-field="powerRequirements">${powerRequirements}</td>
                    <td data-field="roleType"><span class="badge rounded-pill ${badgeClass}">${roleType.replace('-', ' ')}</span></td>
                    <td>${isEdited ? '<span class="badge bg-warning">Edited</span>' : '<span class="badge bg-secondary">Auto</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${itemId}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        ${isEdited ? `
                        <button class="btn btn-sm btn-outline-danger revert-btn" data-id="${itemId}">
                            <i class="bi bi-arrow-counterclockwise"></i>
                        </button>
                        ` : ''}
                    </td>
                `;
                editableTableBody.appendChild(editableRow);
            });
            
            // Add event listeners for edit buttons
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', handleEditItem);
            });
            
            // Add event listeners for revert buttons
            document.querySelectorAll('.revert-btn').forEach(button => {
                button.addEventListener('click', handleRevertItem);
            });
        }
        
        // Show no data message
        function showNoDataMessage() {
            const tableBody = document.getElementById('inventory-table-body');
            const noDataMessage = document.getElementById('no-data-message');
            
            tableBody.innerHTML = '';
            noDataMessage.classList.remove('d-none');
        }
        
        // Handle editing an inventory item
        function handleEditItem(event) {
            const button = event.currentTarget;
            const itemId = button.dataset.id;
            const row = button.closest('tr');
            
            // Check if we're already in edit mode
            if (row.classList.contains('edit-mode')) {
                // Save the edits
                saveItemEdits(row);
            } else {
                // Switch to edit mode
                row.classList.add('edit-mode');
                
                // Change the edit button to a save button
                button.innerHTML = '<i class="bi bi-check"></i>';
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-outline-success');
                
                // Make fields editable
                const productIdCell = row.querySelector('[data-field="productId"]');
                const descriptionCell = row.querySelector('[data-field="description"]');
                const portSummaryCell = row.querySelector('[data-field="portSummary"]');
                const rackUnitsCell = row.querySelector('[data-field="rackUnits"]');
                const powerRequirementsCell = row.querySelector('[data-field="powerRequirements"]');
                const roleTypeCell = row.querySelector('[data-field="roleType"]');
                
                const productId = productIdCell.textContent;
                const description = descriptionCell.textContent;
                const portSummary = portSummaryCell.textContent;
                const rackUnits = rackUnitsCell.textContent;
                const powerRequirements = powerRequirementsCell.textContent;
                const roleType = roleTypeCell.querySelector('.badge').textContent.trim();
                
                // Replace with input fields
                productIdCell.innerHTML = `<input type="text" class="form-control form-control-sm" value="${productId}">`;
                descriptionCell.innerHTML = `<input type="text" class="form-control form-control-sm" value="${description}">`;
                portSummaryCell.innerHTML = `<input type="text" class="form-control form-control-sm" value="${portSummary}">`;
                rackUnitsCell.innerHTML = `<input type="text" class="form-control form-control-sm" value="${rackUnits}">`;
                powerRequirementsCell.innerHTML = `<input type="text" class="form-control form-control-sm" value="${powerRequirements}">`;
                
                // Create role type dropdown
                const roleSelect = document.createElement('select');
                roleSelect.className = 'form-select form-select-sm';
                
                // Add options for all roles
                const roles = [
                    { value: 'spine', label: 'Spine' },
                    { value: 'leaf', label: 'Leaf' },
                    { value: 'border-leaf', label: 'Border Leaf' },
                    { value: 'apic', label: 'APIC' },
                    { value: 'ndo', label: 'NDO' },
                    { value: 'router', label: 'Router' },
                    { value: 'switch', label: 'Switch' },
                    { value: 'firewall', label: 'Firewall' },
                    { value: 'load-balancer', label: 'Load Balancer' },
                    { value: 'custom', label: 'Custom' }
                ];
                
                roles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.value;
                    option.textContent = role.label;
                    option.selected = role.label.toLowerCase() === roleType.toLowerCase();
                    roleSelect.appendChild(option);
                });
                
                roleTypeCell.innerHTML = '';
                roleTypeCell.appendChild(roleSelect);
            }
        }
        
        // Save edits to an inventory item
        function saveItemEdits(row) {
            const itemId = parseInt(row.dataset.id);
            const hostname = row.dataset.hostname;
            
            // Get the edited values
            const productId = row.querySelector('[data-field="productId"] input').value;
            const description = row.querySelector('[data-field="description"] input').value;
            const portSummary = row.querySelector('[data-field="portSummary"] input').value;
            const rackUnits = row.querySelector('[data-field="rackUnits"] input').value;
            const powerRequirements = row.querySelector('[data-field="powerRequirements"] input').value;
            const roleType = row.querySelector('[data-field="roleType"] select').value;
            
            // Validate inputs
            if (!productId || !description) {
                alert('Product ID and Description are required');
                return;
            }
            
            // Create a new record object with the edited values
            const newRecord = {
                name: hostname,
                conventionType: 'Inventory Item',
                details: {
                    productId: productId,
                    description: description,
                    portSummary: portSummary,
                    rackUnits: rackUnits,
                    powerRequirements: powerRequirements,
                    roleType: roleType,
                    // Mark as edited to prevent overwriting during syncs
                    [EDITED_FLAG]: true
                },
                userDescription: `Edited: ${hostname}`
            };
            
            // Check if we're updating an existing record or creating a new one
            if (!isNaN(itemId)) {
                // Try to load the existing record
                loadRecords(TOOL_ID)
                    .then(records => {
                        const record = records.find(r => r.id === itemId);
                        
                        if (record) {
                            // Update existing record
                            if (!record.details) {
                                record.details = {};
                            }
                            
                            record.details.productId = productId;
                            record.details.description = description;
                            record.details.portSummary = portSummary;
                            record.details.rackUnits = rackUnits;
                            record.details.powerRequirements = powerRequirements;
                            record.details.roleType = roleType;
                            record.details[EDITED_FLAG] = true;
                            
                            return updateRecord(TOOL_ID, itemId, record);
                        } else {
                            // Create new record if not found
                            return saveRecord(TOOL_ID, newRecord);
                        }
                    })
                    .then(() => {
                        // Remove edit mode
                        row.classList.remove('edit-mode');
                        
                        // Refresh the data
                        loadInventoryData();
                    })
                    .catch(error => {
                        console.error('Error saving edits:', error);
                        alert('Error saving edits. Please try again.');
                    });
            } else {
                // This is a new entry, save it directly
                saveRecord(TOOL_ID, newRecord)
                    .then(() => {
                        // Remove edit mode
                        row.classList.remove('edit-mode');
                        
                        // Refresh the data
                        loadInventoryData();
                    })
                    .catch(error => {
                        console.error('Error saving new entry:', error);
                        alert('Error saving new entry. Please try again.');
                    });
            }
        }
        
        // Handle reverting an edited item
        function handleRevertItem(event) {
            if (confirm('Are you sure you want to revert this item? It will be synced with the database again.')) {
                const button = event.currentTarget;
                const itemId = parseInt(button.dataset.id);
                
                // Load the current record
                loadRecords(TOOL_ID)
                    .then(records => {
                        const record = records.find(r => r.id === itemId);
                        
                        if (!record) {
                            alert('Error: Record not found');
                            return;
                        }
                        
                        // Remove the edited flag
                        if (record.details) {
                            delete record.details[EDITED_FLAG];
                        }
                        
                        // Update the record in the database
                        return updateRecord(TOOL_ID, itemId, record);
                    })
                    .then(() => {
                        // Refresh the data
                        loadInventoryData();
                    })
                    .catch(error => {
                        console.error('Error reverting item:', error);
                        alert('Error reverting item. Please try again.');
                    });
            }
        }
        
        // Update statistics
        function updateStatistics(items) {
            // Update total devices count
            document.getElementById('total-devices').textContent = items.length;
            
            // Count devices by role
            const roleCounts = {
                'spine': 0,
                'leaf': 0,
                'border-leaf': 0,
                'apic': 0,
                'ndo': 0,
                'router': 0,
                'switch': 0,
                'firewall': 0,
                'load-balancer': 0,
                'custom': 0
            };
            
            items.forEach(item => {
                const roleType = item.roleType || (item.details && item.details.roleType);
                if (roleType && roleCounts.hasOwnProperty(roleType)) {
                    roleCounts[roleType]++;
                }
            });
            
            // Update role counts
            document.getElementById('spine-count').textContent = roleCounts['spine'];
            document.getElementById('leaf-count').textContent = roleCounts['leaf'];
            document.getElementById('border-leaf-count').textContent = roleCounts['border-leaf'];
            document.getElementById('apic-count').textContent = roleCounts['apic'];
            document.getElementById('ndo-count').textContent = roleCounts['ndo'];
        }
    </script>
</body>
</html>
